#Create container for Maker (https://github.com/Yandell-Lab/maker) to run on NEU Discovery
#Modified from: https://github.com/chrishah/maker-docker

FROM ubuntu

MAINTAINER Jason Selwyn "j.selwyn@northeastern.edu"

#RepeatMasker Library = default curated - Dfam

#https://github.com/chrishah/maker-docker/blob/master/ubuntu-basic/Dockerfile
RUN apt-get update --fix-missing
RUN apt-get install -y build-essential vim git wget unzip language-pack-en rsync libcurl4 zlib1g-dev libpq-dev mpich cpio

RUN apt-get install -y perl cpanminus
RUN apt-get install -y python3 python3-pip
RUN pip install h5py
RUN apt-get install -y exonerate hmmer ncbi-blast+
RUN apt-get install -y augustus augustus-data augustus-doc libyaml-perl

#Set language
ENV LANGUAGE en_US.UTF-8
ENV LC_ALL en_US.UTF-8

#Install required PERL modules
RUN cpanm YAML && \
        cpanm Hash::Merge && \
        cpanm Logger::Simple && \
        cpanm Parallel::ForkManager && \
        cpanm Text::Soundex && \
        cpanm File::Which && \
        cpanm Devel::Size && \
	      cpanm MCE::Mutex && \
        cpanm forks && \
        cpanm forks::shared && \
        cpanm File::Which && \
        cpanm Perl::Unsafe::Signals && \
        cpanm Bit::Vector && \
        cpanm Inline::C && \
        cpanm IO::All && \
        cpanm IO::Prompt && \
        cpanm BioPerl && \
        cpanm DBD::SQLite && \
        cpanm DBD::Pg

#Add blast executables to location expected by RepeatModeler
RUN for f in $(find /usr/bin/ -name '*blast*'); do ln -s $f /usr/local/bin/; done
RUN ln -s /usr/bin/python3 /usr/bin/python
RUN ln -s /usr/bin/dustmasker /usr/local/bin/dustmasker

#https://github.com/chrishah/maker-docker/blob/master/ab-initio/Dockerfile
# install SNAP
WORKDIR /usr/src
RUN git clone --recursive https://github.com/KorfLab/SNAP.git \
  && cd /usr/src/SNAP \
  && make \
  && cd /usr/src
ENV ZOE="/usr/src/SNAP/Zoe"

#Download blat
WORKDIR /usr/bin
RUN rsync -aP rsync://hgdownload.soe.ucsc.edu/genome/admin/exe/linux.x86_64/blat/blat /usr/bin/
ENV PATH="/usr/src/SNAP:/usr/share/augustus/scripts:${PATH}"

#GeneMark
RUN mkdir /usr/local/Genemark
ENV PATH="/usr/local/Genemark:${PATH}"

#https://github.com/chrishah/maker-docker/blob/master/repeatmasker/Dockerfile
#install Repeatmasker (much of this was taken and slighly modified from robsyme/repeatmasker-onbuild)
# Install TRF - Tandem Repeat Finder (for RepeatScout)
WORKDIR /usr/local
RUN cd bin && \
  wget http://tandem.bu.edu/trf/downloads/trf407b.linux64 && \
  mv trf*.linux64 trf && \
  chmod +x trf

# Install nseg (for RepeatScout)
WORKDIR /usr/local
RUN mkdir nseg && \
    cd nseg && \
    wget ftp://ftp.ncbi.nih.gov/pub/seg/nseg/* && \
    make && \
    mv nseg ../bin && \
    mv nmerge ../bin

# Install RepeatScout
WORKDIR /usr/local/bin
RUN wget http://bix.ucsd.edu/repeatscout/RepeatScout-1.0.5.tar.gz && \
    tar -xvf RepeatScout* && \
    rm RepeatScout*.tar.gz && \
    mv RepeatScout* RepeatScout && \
    cd RepeatScout && \
    make

# Install RMBlast
WORKDIR /usr/local
RUN wget ftp://ftp.ncbi.nlm.nih.gov/blast/executables/blast+/2.11.0/ncbi-blast-2.11.0+-src.tar.gz \
  && wget http://www.repeatmasker.org/isb-2.11.0+-rmblast.patch.gz \
  && tar zxvf ncbi-blast*.tar.gz \
  && rm -rf ncbi-blast*.tar.gz \
  && gunzip isb-*-rmblast.patch.gz \
  && cd ncbi-blast*src
WORKDIR /usr/local/ncbi-blast-2.11.0+-src
RUN patch -p1 < /usr/local/isb-2.11.0+-rmblast.patch
WORKDIR /usr/local/ncbi-blast-2.11.0+-src/c++
RUN ./configure \
      --with-mt \
      --without-debug \
      --without-krb5 \
      --without-openssl \
      --with-projects=scripts/projects/rmblastn/project.lst \
      --prefix=/usr/local/rmblast
RUN make
RUN make install
#softlink blastn to rmblastn since they should be the same????
#RUN ln -s /usr/local/rmblast/bin/rmblastn /usr/local/bin/rmblastn
ENV PATH="/usr/local/rmblast/bin:${PATH}"

# Install RepeatMasker - https://www.repeatmasker.org/RepeatMasker/
WORKDIR /usr/local
RUN wget https://www.repeatmasker.org/RepeatMasker/RepeatMasker-4.1.2-p1.tar.gz \
  && tar -xzvf RepeatMasker*.tar.gz \
  && rm -f RepeatMasker*.tar.gz \
  && cd /usr/local/RepeatMasker

#Takes a very long time - get this working then sideload the full Dfam library
#RUN wget https://www.dfam.org/releases/Dfam_3.2/families/Dfam.h5.gz \
#  && gunzip Dfam.h5.gz \
#  && mv Dfam.h5 /usr/local/RepeatMasker/Libraries

#Here is where to install alternate RepeatMasker Libraries
#Add RepBase RepeatMasker Edition ( final version 10/26/2018 ) Library (?) - have *fasta version...will that work??
#Requires license
#https://www.repeatmasker.org/RepeatMasker/

ADD RepBaseRepeatMaskerEdition-20181026.tar.gz /usr/local/RepeatMasker

WORKDIR /usr/local/RepeatMasker
