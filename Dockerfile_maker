#Create container for Maker (https://github.com/Yandell-Lab/maker) to run on NEU Discovery
#Modified from: https://github.com/chrishah/maker-docker

FROM ubuntu

MAINTAINER Jason Selwyn "j.selwyn@northeastern.edu"

#RepeatMasker Library = default curated - Dfam

#https://github.com/chrishah/maker-docker/blob/master/ubuntu-basic/Dockerfile
RUN apt-get update --fix-missing
RUN apt-get install -y build-essential vim git wget unzip language-pack-en rsync libcurl4 zlib1g-dev

RUN apt-get install -y perl cpanminus
RUN apt-get install -y python3 python3-pip
RUN pip install h5py
RUN apt-get install -y exonerate hmmer ncbi-blast+

#Add blast executables to location expected by RepeatModeler
RUN for f in $(find /usr/bin/ -name '*blast*'); do ln -s $f /usr/local/bin/; done
RUN ln -s /usr/bin/python3 /usr/bin/python

#Set language
ENV LANGUAGE en_US.UTF-8
ENV LC_ALL en_US.UTF-8


#https://github.com/chrishah/maker-docker/blob/master/ab-initio/Dockerfile
WORKDIR /usr/src

#install SNAP
RUN git clone --recursive https://github.com/KorfLab/SNAP.git
WORKDIR /usr/src/SNAP
RUN make
WORKDIR /usr/src
ENV ZOE="/usr/src/SNAP/Zoe"

# install Augustus
RUN apt-get install -y augustus augustus-data augustus-doc libyaml-perl

#Download blat
RUN rsync -aP rsync://hgdownload.soe.ucsc.edu/genome/admin/exe/linux.x86_64/blat/blat /usr/bin/

ENV PATH="/usr/src/SNAP:/usr/share/augustus/scripts:${PATH}"

WORKDIR /usr/local/bin

#install perl modules required for Genemark
RUN cpanm YAML && \
        cpanm Hash::Merge && \
        cpanm Logger::Simple && \
        cpanm Parallel::ForkManager && \
        cpanm Text::Soundex && \
        cpanm File::Which && \
        cpanm Devel::Size && \
	cpanm MCE::Mutex && \
	mkdir /usr/local/Genemark

#add the (at this point empty) Genemark directory to the path in anticipation
ENV PATH="/usr/local/Genemark:${PATH}"

#https://github.com/chrishah/maker-docker/blob/master/repeatmasker/Dockerfile
#install Repeatmasker (much of this was taken and slighly modified from robsyme/repeatmasker-onbuild)
# Install TRF - Tandem Repeat Finder (for RepeatScout)
WORKDIR /usr/local
RUN cd bin && wget http://tandem.bu.edu/trf/downloads/trf407b.linux64 && mv trf*.linux64 trf && chmod +x trf

# Install nseg (for RepeatScout)
RUN mkdir nseg && \
    cd nseg && \
    wget ftp://ftp.ncbi.nih.gov/pub/seg/nseg/* && \
    make && \
    mv nseg ../bin && \
    mv nmerge ../bin

# Install RepeatScout
WORKDIR /usr/local/bin
RUN wget http://bix.ucsd.edu/repeatscout/RepeatScout-1.0.5.tar.gz && \
    tar -xvf RepeatScout* && \
    rm RepeatScout*.tar.gz && \
    mv RepeatScout* RepeatScout && \
    cd RepeatScout && \
    make

# Install RMBlast (Repeatmasker expects makeblastdb and blastx in the same location as rmblastn) - http://www.repeatmasker.org/RMBlast.html
WORKDIR /usr/local
RUN wget http://www.repeatmasker.org/rmblast-2.11.0+-x64-linux.tar.gz
RUN tar -xzvf rmblast*tar.gz && rm rmblast*tar.gz
RUN mv rmblast*/bin/rmblastn /usr/local/bin && rm -rf rmblast*

# Install RepeatMasker - https://www.repeatmasker.org/RepeatMasker/
RUN wget https://www.repeatmasker.org/RepeatMasker/RepeatMasker-4.1.2-p1.tar.gz
RUN tar -xzvf RepeatMasker*.tar.gz && rm -f RepeatMasker*.tar.gz
WORKDIR /usr/local/RepeatMasker
#RUN perl ./configure
