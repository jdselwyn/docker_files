#Create container for Maker (https://github.com/Yandell-Lab/maker) to run on NEU Discovery
#Modified from: https://github.com/chrishah/maker-docker

FROM ubuntu

MAINTAINER Jason Selwyn "j.selwyn@northeastern.edu"

#https://github.com/chrishah/maker-docker/blob/master/ubuntu-basic/Dockerfile
RUN apt-get update --fix-missing
RUN apt-get install -y build-essential vim git wget unzip language-pack-en rsync libcurl4

RUN apt-get install -y perl cpanminus
RUN apt-get install -y python3 python3-pip
RUN apt-get install -y exonerate hmmer ncbi-blast+

#Add blast executables to location expected by RepeatModeler
RUN for f in $(find /usr/bin/ -name '*blast*'); do ln -s $f /usr/local/bin/; done
RUN ln -s /usr/bin/python3 /usr/bin/python

#Set language
ENV LANGUAGE en_US.UTF-8
ENV LC_ALL en_US.UTF-8


#https://github.com/chrishah/maker-docker/blob/master/ab-initio/Dockerfile
WORKDIR /usr/src

#install SNAP
RUN git clone --recursive https://github.com/KorfLab/SNAP.git
WORKDIR /usr/src/SNAP
RUN make
WORKDIR /usr/src
ENV ZOE="/usr/src/SNAP/Zoe"

# install Augustus
RUN apt install -y augustus augustus-data augustus-doc libyaml-perl

#Download blat
RUN rsync -aP rsync://hgdownload.soe.ucsc.edu/genome/admin/exe/linux.x86_64/blat/blat /usr/bin/

ENV PATH="/usr/src/SNAP:/usr/share/augustus/scripts:${PATH}"

WORKDIR /usr/local/bin

#install perl modules required for Genemark
RUN cpanm YAML && \
        cpanm Hash::Merge && \
        cpanm Logger::Simple && \
        cpanm Parallel::ForkManager && \
	cpanm MCE::Mutex && \
	mkdir /usr/local/Genemark

#add the (at this point empty) Genemark directory to the path in anticipation
ENV PATH="/usr/local/Genemark:${PATH}"

#https://github.com/chrishah/maker-docker/blob/master/repeatmasker/Dockerfile
#install Repeatmasker (much of this was taken and slighly modified from robsyme/repeatmasker-onbuild)
# Install TRF (for RepeatScout)
WORKDIR /usr/local
RUN cd bin && wget http://tandem.bu.edu/trf/downloads/trf407b.linux64 && mv trf*.linux64 trf && chmod +x trf

# Install nseg (for RepeatScout)
RUN mkdir nseg && \
    cd nseg && \
    wget ftp://ftp.ncbi.nih.gov/pub/seg/nseg/* && \
    make && \
    mv nseg ../bin && \
    mv nmerge ../bin

# Install RepeatScout
WORKDIR /usr/local/bin
RUN wget http://bix.ucsd.edu/repeatscout/RepeatScout-1.0.5.tar.gz && \
    tar -xvf RepeatScout* && \
    rm RepeatScout*.tar.gz && \
    mv RepeatScout* RepeatScout && \
    cd RepeatScout && \
    make

# Install RMBlast (Repeatmasker expects makeblastdb and blastx in the same location as rmblastn) - http://www.repeatmasker.org/RMBlast.html
WORKDIR /usr/local
RUN wget http://www.repeatmasker.org/rmblast-2.11.0+-x64-linux.tar.gz
RUN tar -xzvf rmblast*tar.gz && rm rmblast*tar.gz
RUN mv rmblast*/bin/rmblastn /usr/local/bin && rm -rf rmblast*

# Install RepeatMasker - https://www.repeatmasker.org/RepeatMasker/
RUN wget https://www.repeatmasker.org/RepeatMasker/RepeatMasker-4.1.2-p1.tar.gz
RUN tar -xzvf RepeatMasker*.tar.gz && rm -f RepeatMasker*.tar.gz

#JDS - skipped unsure what it does
#	&& perl -0p -e 's/\/usr\/local\/hmmer/\/usr\/bin/g;' \
#	-e 's/\/usr\/local\/rmblast/\/usr\/local\/bin/g;' \
#    -e 's/DEFAULT_SEARCH_ENGINE = "crossmatch"/DEFAULT_SEARCH_ENGINE = "ncbi"/g;' \
#    -e 's/TRF_PRGM = ""/TRF_PRGM = "\/usr\/local\/bin\/trf"/g;' RepeatMasker/RepeatMaskerConfig.tmpl > RepeatMasker/RepeatMaskerConfig.pm

#Install Repeatmasker dependency perl module
RUN cpanm Text::Soundex

#JDS - skipped they look fine??
# Fix RepeatMasker's strange shebang lines
#RUN cd /usr/local/RepeatMasker \
#	&& perl -i -0pe 's/^#\!.*perl.*/#\!\/usr\/bin\/env perl/g' \
#	RepeatMasker \
#    DateRepeats \
#    ProcessRepeats \
#    RepeatProteinMask \
#    DupMasker \
#    util/queryRepeatDatabase.pl \
#    util/queryTaxonomyDatabase.pl \
#    util/rmOutToGFF3.pl \
#    util/rmToUCSCTables.pl

#Add RepBase RepeatMasker Edition ( final version 10/26/2018 ) Library (?)
#Requires license
#    cp RepBaseRepeatMaskerEdition-20181026.tar.gz /usr/local/RepeatMasker/
#    cd /usr/local/RepeatMasker
#    gunzip RepBaseRepeatMaskerEdition-20181026.tar.gz
#    tar xvf RepBaseRepeatMaskerEdition-20181026.tar
#    rm RepBaseRepeatMaskerEdition-20181026.tar
