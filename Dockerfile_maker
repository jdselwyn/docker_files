#Create container for Maker (https://github.com/Yandell-Lab/maker) to run on NEU Discovery
#Modified from: https://github.com/chrishah/maker-docker

FROM ubuntu

MAINTAINER Jason Selwyn "j.selwyn@northeastern.edu"

#RepeatMasker Library = default curated - Dfam

#https://github.com/chrishah/maker-docker/blob/master/ubuntu-basic/Dockerfile
RUN apt-get update --fix-missing
RUN apt-get install -y build-essential vim git wget unzip language-pack-en rsync libcurl4 zlib1g-dev

RUN apt-get install -y perl cpanminus
RUN apt-get install -y python3 python3-pip
RUN pip install h5py
RUN apt-get install -y exonerate hmmer ncbi-blast+

#Add blast executables to location expected by RepeatModeler
RUN for f in $(find /usr/bin/ -name '*blast*'); do ln -s $f /usr/local/bin/; done
RUN ln -s /usr/bin/python3 /usr/bin/python

#Set language
ENV LANGUAGE en_US.UTF-8
ENV LC_ALL en_US.UTF-8


#https://github.com/chrishah/maker-docker/blob/master/ab-initio/Dockerfile
WORKDIR /usr/src

#install SNAP
RUN git clone --recursive https://github.com/KorfLab/SNAP.git
WORKDIR /usr/src/SNAP
RUN make
WORKDIR /usr/src
ENV ZOE="/usr/src/SNAP/Zoe"

# install Augustus
RUN apt-get install -y augustus augustus-data augustus-doc libyaml-perl

#Download blat
RUN rsync -aP rsync://hgdownload.soe.ucsc.edu/genome/admin/exe/linux.x86_64/blat/blat /usr/bin/

ENV PATH="/usr/src/SNAP:/usr/share/augustus/scripts:${PATH}"

WORKDIR /usr/local/bin

#install perl modules required for Genemark
RUN cpanm YAML && \
        cpanm Hash::Merge && \
        cpanm Logger::Simple && \
        cpanm Parallel::ForkManager && \
        cpanm Text::Soundex && \
        cpanm File::Which && \
        cpanm Devel::Size && \
	cpanm MCE::Mutex && \
	mkdir /usr/local/Genemark

#add the (at this point empty) Genemark directory to the path in anticipation
ENV PATH="/usr/local/Genemark:${PATH}"

#https://github.com/chrishah/maker-docker/blob/master/repeatmasker/Dockerfile
#install Repeatmasker (much of this was taken and slighly modified from robsyme/repeatmasker-onbuild)
# Install TRF - Tandem Repeat Finder (for RepeatScout)
WORKDIR /usr/local
RUN cd bin && wget http://tandem.bu.edu/trf/downloads/trf407b.linux64 && mv trf*.linux64 trf && chmod +x trf

# Install nseg (for RepeatScout)
RUN mkdir nseg && \
    cd nseg && \
    wget ftp://ftp.ncbi.nih.gov/pub/seg/nseg/* && \
    make && \
    mv nseg ../bin && \
    mv nmerge ../bin

# Install RepeatScout
WORKDIR /usr/local/bin
RUN wget http://bix.ucsd.edu/repeatscout/RepeatScout-1.0.5.tar.gz && \
    tar -xvf RepeatScout* && \
    rm RepeatScout*.tar.gz && \
    mv RepeatScout* RepeatScout && \
    cd RepeatScout && \
    make

# Install RMBlast (Repeatmasker expects makeblastdb and blastx in the same location as rmblastn) - http://www.repeatmasker.org/RMBlast.html
WORKDIR /usr/local
RUN wget http://www.repeatmasker.org/rmblast-2.11.0+-x64-linux.tar.gz
RUN tar -xzvf rmblast*tar.gz && rm rmblast*tar.gz
RUN mv rmblast*/bin/rmblastn /usr/local/bin && rm -rf rmblast*

# Install RepeatMasker - https://www.repeatmasker.org/RepeatMasker/
RUN wget https://www.repeatmasker.org/RepeatMasker/RepeatMasker-4.1.2-p1.tar.gz
RUN tar -xzvf RepeatMasker*.tar.gz && rm -f RepeatMasker*.tar.gz
WORKDIR /usr/local/RepeatMasker
RUN printf '\n3\n\n\n5\n' | perl ./configure


#Here is where to install alternate RepeatMasker Libraries
#Add RepBase RepeatMasker Edition ( final version 10/26/2018 ) Library (?) - have *fasta version...will that work??
#Requires license
#https://www.repeatmasker.org/RepeatMasker/

# Install RIPcal (not sure if this is actually needed for maker)
WORKDIR /usr/local
RUN wget http://downloads.sourceforge.net/project/ripcal/RIPCAL/RIPCAL_2.0/ripcal2_install.zip \
	&& unzip ripcal*.zip \
	&& rm ripcal*.zip \
	&& mv ripcal* ripcal \
	&& cd ripcal \
	&& chmod +x perl/*

# Install RECON (not sure if this is actually needed for maker)
WORKDIR /usr/local
RUN wget http://www.repeatmasker.org/RepeatModeler/RECON-1.08.tar.gz \
	&& tar -xzvf RECON* \
	&& rm RECON*.tar.gz \
	&& mv RECON* recon \
	&& cd recon/src \
	&& make \
	&& make install \
	&& perl -i -0pe 's/\$path = "";/\$path = "\/usr\/local\/recon\/bin";/g' ../scripts/\recon.pl

# Install RepeatModeler deps (not sure if this is actually needed for maker)
WORKDIR /usr/local
RUN apt-get install -qqy libjson-perl liburi-perl liblwp-useragent-determined-perl && \
	apt-get clean && apt-get purge && \
        rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

#Install CD-hit
WORKDIR /usr/local
RUN git clone https://github.com/weizhongli/cdhit \
  && cd cdhit \
  && make

#Install UCSC Tools
WORKDIR /usr/local/ucscTools
RUN rsync -aP hgdownload.soe.ucsc.edu::genome/admin/exe/linux.x86_64/ ./

#Install NINJA
WORKDIR /usr/local
RUN git clone https://github.com/TravisWheelerLab/NINJA \
  && cd NINJA \
  && git checkout cluster \
  && mv NINJA/* ./ \
  && rm -rf NINJA \
  && make

#Install MAFFT
WORKDIR /usr/local
RUN wget https://mafft.cbrc.jp/alignment/software/mafft_7.490-1_amd64.deb \
  && dpkg -i mafft*deb

#Install LTR_retriever
WORKDIR /usr/local
RUN git clone https://github.com/oushujun/LTR_retriever \
  && cd LTR_retriever \
  && mv paths original_paths \
  && echo "BLAST+=/usr/lib/ncbi-blast+" > paths \
  && echo "RepeatMasker=/usr/local/RepeatMasker" >> paths \
  && echo "HMMER=/usr/bin" >> paths \
  && echo "CDHIR=/usr/local/cdhit" >> paths \
  && echo "BLAST=" >> paths #intentionally not entered


# Install RepeatModeler (not sure this is actually needed for maker)
WORKDIR /usr/local
RUN wget https://www.repeatmasker.org/RepeatModeler/RepeatModeler-2.0.3.tar.gz \
  && tar -xzvf RepeatModeler-*.tar.gz \
  && rm RepeatModeler-*.tar.gz \
  && mv RepeatModeler-*/ RepeatModeler \
  && cd RepeatModeler

WORKDIR /usr/local/RepeatModeler
RUN printf '\n' | \
  perl ./configure \
    -genometools_dir /usr/local/ucscTools \
    -rscout_dir /usr/local/bin/RepeatScout \
    -cdhit_dir /usr/local/cdhit \
    -ninja_dir /usr/local/NINJA \
    -mafft_dir /usr/bin \
    -repeatmasker_dir /usr/local/RepeatMasker \
    -recon_dir /usr/local/recon/src \
    -rmblast_dir /usr/local/bin \
    -trf_dir /usr/local/bin \
    -ucsctools_dir /usr/local/ucscTools \
    -ltr_retriever_dir /usr/local/LTR_retriever
#RepeatModeler doesn't appear to work at the moment (20-July-22) because of something wrong with rmblast_dir - dustmaker


#Set PATH
ENV PATH="/usr/local/RepeatMasker:/usr/local/RepeatMasker/util:/usr/local/RepeatScout:/usr/local/recon/bin:/usr/local/RepeatModeler:${PATH}"

#Install Maker Now
WORKDIR /usr/local
RUN git clone https://github.com/Yandell-Lab/maker
